<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="../favicon.ico">
	<title>Mintverse</title>
	<meta property="og:image" content="../cover.png"/>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/_reset.css">
	<link rel="stylesheet" href="../css/header.css">
	<link rel="stylesheet" href="../css/footer.css">
	<link rel="stylesheet" href="../css/literature.css">
	<link rel="stylesheet" href="../css/article.css">
	<script src="../js/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery.marquee@1.6.0/jquery.marquee.min.js"></script>
	<script src="../js/header.js"></script>
	<script src="../js/footer.js"></script>
</head>
<body>
	<div id="app">
		<header>
		</header>
		<section class="literature">
			<h3>鑄造小組發現了人類僅存的十篇文獻，然而文獻中的詞彙盡皆散佚，等待各位注入定義後解鎖。</h3>
			<div class="cardContainer">
			</div>
		</section>
		<section class="article">
			<div class="back pointer"><img src="../image/back.svg" alt=""> 返回</div>
			<h1 class="title"></h1>
			<h3 class="author"></h3>
			<button style="cursor:pointer;"><img src="../image/back_orange.svg" alt="">其他的可能宇宙</button>
			<div class="content"></div>
			<div class="goTop"><img src="../image/back.svg" alt="">TOP</div>
		</section>
		<div class="message">
			<div class="word">
				<a href=""  target="_blank" ><img src="../image/opensea.png" alt=""></a>
				<p></p>
			</div>
			<div class="context"></div>
		</div>
		<footer>
		</footer>
	</div>
	<script>
		$(document).ready(function() {
			let authorData = []
			let articleDetail;
			let articleId = null;
			const SearchURL = new URL(window.location.href);
			let params = SearchURL.searchParams;
			if(params.has('article')){
				getDetailArticle();
				$('.literature').hide();
				$('.article').show();
				articleId = params.get('article');
				$('#app').addClass('articlePage')
				renderArticle();
			}else{
				$('.literature').show();
				$('.article').hide();
				init();
			}
			$('header').setHeader();
			$('footer').setFooter();

			$('.content span').on('click', function(event) {
				event.preventDefault();
				console.log(event.currentTarget.innerHtml)
				//event.currentTarget.attributes['data-url'].value
				$('.message .word p').text(event.currentTarget.innerHTML);
				$('.message .context').text(event.currentTarget.attributes['data-discript'].value);
				$('.message .word a').attr("href", event.currentTarget.attributes['data-url'].value);
				$('.message').show(400);
				$('.message').css('display', 'flex');
			});
			$('.message').on('click', function(event) {
				//event.preventDefault();
				/* Act on the event */
				console.log(event)
				$('.message').hide();
			});
			$('.article button').on('click', replaceContext);
			async function getDetailArticle(){
				let endpoint;
				
				endpoint = `http://54.248.1.203:8080/api/mintverse/author/${articleId}`
				let data = await $.ajax({
			  		type: "GET",
				    url: endpoint,
				    dataType: "json",
				    success: function (response) {
				    	//id article article_title name written_percentage reserved_tokens
				    	articleDetail = response.author;
				    },
				    error: function (thrownError) {
				      	console.log(thrownError);
				    }
			  	})
				
			}
			async function init(){
				let endpoint;
				for (var i = 0; i < 11; i++) {
					if(i != 1){;
						endpoint = `http://54.248.1.203:8080/api/mintverse/author/${i}`
						let data = await $.ajax({
					  		type: "GET",
						    url: endpoint,
						    dataType: "json",
						    success: function (response) {
						    	//id article article_title name written_percentage reserved_tokens
						    	let json = response.author;
						    	//json.written_percentage = Math.floor(json.written_percentage*100);
						    	json.written_percentage = 100;
						      	authorData.push(json)
						    },
						    error: function (thrownError) {
						      	console.log(thrownError);
						    }
					  	})
					}
				}
				authorData.sort(function(a, b) {
			    	return b.written_percentage - a.written_percentage;
				});
				authorData.forEach( function(item, index){
					let persentCheck = item.written_percentage >= 80 ? true : false;
					let title = item.article_title;
					let author = item.name;
					if( author == '李屏瑤'){
						title = insertStr(title, 3 , '<br>')
					}
					if( author == '黃麗群'){
						title = insertStr(title, 8 , '<br>');
						title = insertStr(title, title.length - 5 , '<br>');
					}
					$('.cardContainer').append(`<div class="card"><div class="info"><h3>${title}</h3><p>作家 ${author}</p></div><h2><span>${item.written_percentage}%</span><span>${'解鎖完成'}</span></h2></div>`)
					if(!persentCheck){
						$('.card').eq(index) .addClass('lock');
					}else{
						$('.card').eq(index) .addClass('unlock');
					}
					if(author == '李屏瑤'){
						$('.card').eq(index) .addClass('li');
					}
					if(author == '黃麗群'){
						$('.card').eq(index) .addClass('haung');
					}
					
				})
			}
			function replaceContext(){
				let replacArticle;
				$('.article .content').empty();
				replacArticle = replaceKeyWord(articleId, 1);
				$('.article .content').append(replacArticle);
			}
			function renderArticle(){
				let replacArticle
				replacArticle = replaceKeyWord(articleId, 0);
				$('.article .title').append(authorData[articleId].article_title);
				$('.article .author').append('作家'+' '+authorData[articleId].name);
				$('.article .content').append(replacArticle);
			}
			function replaceKeyWord(id, status){
				let data = articleDetail
				let article;
				if(status == 0){
					data.reserved_tokens.forEach( function(keyword, index) {
						article = data.article.replaceAll(keyword.word.word, `<span data-discript="${keyword.word.context}" data-url="${keyword.opensea_url}">${keyword.word.word}</span>`)
					});
				}else{
					data.reserved_tokens.forEach( function(keyword, index) {
						let num = getRandom(keyword.word.synonyms.length)
						article = data.article.replaceAll(keyword.word.word, `<span data-discript="${keyword.word.context}" data-url="${keyword.opensea_url}">${keyword.word.synonyms[num]}</span>`)
					});
				}
				return article;
			}
			$('.card').on('click', function(event) {
				event.preventDefault();
				/* Act on the event */
				let index = $( ".card" ).index( this );
				if(authorData[index].persent < 80) return;
				location.href = location.href + '?article=' + authorData[index].id
			});
			$('.back').on('click', function(event) {
				event.preventDefault();
				/* Act on the event */
				location.href = '/literature'
			});
			$('.goTop').on('click', function(event) {
				event.preventDefault();
				/* Act on the event */
				$('html, body').animate({scrollTop : 0},800);
				return false;
			});
			function insertStr(soure,start, newStr) {
  				return soure.slice(0, start) + newStr + soure.slice(start)
			}
			function getRandom(x){
			    return Math.floor(Math.random()*x);
			};
		})
	</script>
</body>
</html>